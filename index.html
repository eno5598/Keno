<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KENO – Kombinationen suchen + Tipp prüfen</title>
<style>
  body{margin:0;padding:16px;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#e5e7eb}
  .box{max-width:900px;margin:0 auto;background:#111827;border:1px solid #223046;border-radius:10px;padding:14px}
  h1{margin:0 0 10px}
  label{display:block;margin:8px 0 4px;color:#a1a1aa}
  input[type="file"],input[type="number"],input[type="text"]{width:100%;box-sizing:border-box;padding:10px;border-radius:8px;border:1px solid #263041;background:#0b1220;color:#e5e7eb}
  a{color:#93c5fd;text-decoration:none}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>div{flex:1 1 180px}
  button{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .primary{background:linear-gradient(135deg,#059669,#22c55e);color:#04110a}
  .secondary{background:#1f2937;color:#e5e7eb;border:1px solid #263041}
  .danger{background:#7f1d1d;color:#fee2e2;border:1px solid #991b1b}
  .status{margin-top:8px;font-family:ui-monospace,Consolas,Menlo,monospace;background:#0b1220;border:1px solid #263041;border-radius:8px;padding:8px;white-space:pre-wrap}
  .results{margin-top:10px;font-family:ui-monospace,Consolas,Menlo,monospace;white-space:pre}
  .hint{color:#9ca3af;font-size:14px;margin-top:4px}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{background:#0b1220;border:1px solid #263041;border-radius:999px;padding:6px 10px}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #263041;margin-left:8px}
  .section{margin-top:12px;padding-top:8px;border-top:1px dashed #2a3648}
</style>
</head>
<body>
  <div class="box">
    <h1>KENO – Kombinationen suchen</h1>

    <!-- Fester Archiv-Link (ersetzt) -->
    <p>
      Gewinnzahlen/Archiv (Lotto Bayern):
      <a href="https://www.lotto-bayern.de/keno/gewinnzahlen" target="_blank" rel="noopener">
        lotto-bayern.de/keno/gewinnzahlen
      </a>
    </p>

    <label>Archiv-CSV/TXT hochladen</label>
    <input type="file" id="file"
      accept=".csv,.txt,text/csv,application/csv,application/vnd.ms-excel,application/octet-stream,text/plain">
    <div class="hint">Unterstützt: eine Spalte „1-4-…“ ODER Tabellen (Tag/Monat/Jahr/VA/Zahl1..Zahl20). Datei bleibt lokal.</div>

    <!-- Muster optional (nur Textfeld, volle Breite) -->
    <div class="section">
      <label><input type="checkbox" id="usePattern"> Muster-Abstände verwenden (optional)</label>
      <div id="patternBox" style="display:none">
        <label>Abstände als Liste eingeben</label>
        <input type="text" id="gapList" placeholder="z. B. 1,5,6,2,20,4,1,1,2" style="width:100%;margin-bottom:8px">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button id="gapApply" class="secondary">Muster übernehmen</button>
          <button id="gapUndo" class="danger">↶ Rückgängig</button>
          <button id="gapClear" class="danger">✖️ Alles löschen</button>
        </div>
        <div class="chips" id="chips"></div>
        <div class="hint">Muster ergibt <span id="sOut" class="badge">S = 1 Zahl</span> (Felder = Abstände + 1)</div>
      </div>
    </div>

    <!-- Zufallsmodus -->
    <div class="row section">
      <div><label>Kombi-Größe S</label><input type="number" id="size" value="10" min="1" max="20"></div>
      <div><label>Max. erlaubte Überschneidung</label><input type="number" id="maxOv" value="7" min="0" max="20"></div>
      <div><label>Wieviele Ergebnisse</label><input type="number" id="want" value="10" min="1" max="1000"></div>
      <div><label>Max. Versuche</label><input type="number" id="tries" value="60000" min="1000" step="1000"></div>
    </div>

    <!-- Bereich + Seed -->
    <div class="row">
      <div><label>Zahlenbereich – Von</label><input type="number" id="rangeFrom" value="1" min="1" max="200"></div>
      <div><label>Zahlenbereich – Bis</label><input type="number" id="rangeTo" value="70" min="1" max="200"></div>
      <div><label>Seed</label><input type="number" id="seed" value="1" min="0"></div>
    </div>

    <!-- Tipp prüfen -->
    <div class="section">
      <h3 style="margin:0 0 6px">Tipp prüfen</h3>
      <label>Dein Tipp (Zahlen mit Leerzeichen/Komma)</label>
      <input type="text" id="tipInput" placeholder="z. B. 10 11 16 22 24 44 48 49 50 52">
      <div class="row" style="margin-top:6px">
        <div>
          <label>Überschneidung zählen ab (≥)</label>
          <input type="number" id="thrA" value="7" min="1" max="20">
        </div>
        <div>
          <label>2. Schwelle (optional, ≥)</label>
          <input type="number" id="thrB" value="8" min="1" max="20">
        </div>
      </div>
      <div style="margin-top:6px"><button id="checkTip" class="secondary">Tipp analysieren</button></div>
      <div id="tipStatus" class="status" style="display:none"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="go" class="primary">Generieren</button>
      <button id="save" class="secondary">Als CSV speichern</button>
      <button id="clearCache" class="danger">Archiv löschen</button>
    </div>

    <div id="status" class="status">Bereit. (Kein Archiv geladen)</div>
    <div id="results" class="results"></div>
  </div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const CACHE_KEY="keno_archive_v3", PATTERN_KEY="keno_pattern_v1", USEPAT_KEY="keno_usepat_v1";
  let g_draws=[], g_drawSize=0, g_pattern=[];

  // Parser für CSV/TXT (Komma/; | Tab | mehrere Leerzeichen)
  function splitSmart(line){
    if(/\t/.test(line)) return line.split("\t");
    if(line.includes(";")) return line.split(";");
    if(line.includes("|")) return line.split("|");
    if(/,/.test(line) && !/^\d+(-\d+)+$/.test(line.trim())) return line.split(",");
    return line.trim().split(/\s+/);
  }
  function parseTable(text){return text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean).map(splitSmart);}

  // „eine Spalte mit 1-4-…“
  function detectNumbersColumn(rows){
    const maxCols=rows.reduce((m,r)=>Math.max(m,r.length),0);
    let best=-1,score=-1;
    for(let c=0;c<maxCols;c++){
      let sc=0;
      for(const r of rows){
        if(c>=r.length) continue;
        const cell=String(r[c]||"").trim();
        if(!cell) continue;
        const parts=cell.split("-").map(s=>s.trim());
        if(parts.length>=5 && parts.every(p=>/^\d+$/.test(p))) sc++;
      }
      if(sc>score){score=sc;best=c;}
    }
    return best;
  }

  // „Zahl1..Zahl20“-Tabellen (Header oder Heuristik 5–24)
  function tryZahlColumns(rows){
    if(!rows.length) return null;
    const header=rows[0].map(x=>String(x).trim());
    const idx=header.map((h,i)=>/^zahl\s*\d+$/i.test(h)?i:-1).filter(i=>i>=0);
    if(idx.length>=5){
      const lists=[];
      for(let r=1;r<rows.length;r++){
        const nums=idx.map(i=>rows[r][i]).map(v=>parseInt(String(v||"").trim(),10)).filter(Number.isInteger);
        if(nums.length) lists.push(nums);
      }
      return{lists,info:`Header erkannt (${idx.length} Zahl-Spalten)`};
    }
    if(rows[0].length>=24){
      const lists=[];
      for(const row of rows){
        const seg=row.slice(4,24).map(x=>parseInt(String(x).trim(),10)).filter(Number.isInteger);
        if(seg.length>=5) lists.push(seg);
      }
      if(lists.length) return{lists,info:"Heuristik: Spalten 5–24"};
    }
    return null;
  }

  // Bitset & Suche
  const toBits=arr=>arr.reduce((b,v)=>b|(1n<<BigInt(v-1)),0n);
  function overlapUpTo(cb,db,stopAt){let x=cb&db,c=0;while(x){x&=(x-1n);c++;if(c>stopAt)break;}return c;}
  function isValid(cand,drawsBits,maxOv){const cb=toBits(cand);for(const db of drawsBits){if(overlapUpTo(cb,db,maxOv)>maxOv)return false;}return true;}
  function rng(seed){let t=seed>>>0;return()=>{t+=0x6D2B79F5;let r=Math.imul(t^(t>>>15),1|t);r^=r+Math.imul(r^(r>>>7),61|r);return((r^(r>>>14))>>>0)/4294967296;};}
  function sampleRange(A,B,S,rand){const n=B-A+1;if(S>n)return null;const a=Array.from({length:n},(_,i)=>A+i);for(let i=0;i<S;i++){const j=i+Math.floor(rand()*(n-i));[a[i],a[j]]=[a[j],a[i]];}return a.slice(0,S).sort((x,y)=>x-y);}

  // Datei laden
  $("#file").addEventListener("change",async()=>{
    const f=$("#file").files[0];if(!f)return;
    $("#status").textContent="Lese Datei…";
    try{
      const text=await f.text();
      const rows=parseTable(text);
      let lists=[],detected="";
      const z=tryZahlColumns(rows);
      if(z){lists=z.lists;detected=z.info;}
      else{
        const ncol=detectNumbersColumn(rows);
        if(ncol<0) throw new Error("Keine Zahlenspalte erkannt");
        for(const r of rows){
          if(ncol>=r.length) continue;
          const cell=String(r[ncol]||"").trim();if(!cell) continue;
          const parts=cell.split("-").map(s=>s.trim()).filter(Boolean);
          if(!parts.every(p=>/^\d+$/.test(p))) continue;
          lists.push(parts.map(Number));
        }
        detected="Spalte 1-4-…";
      }
      if(!lists.length) throw new Error("Keine gültigen Zahlen gefunden");
      const count=new Map();for(const a of lists){count.set(a.length,(count.get(a.length)||0)+1);}
      g_drawSize=[...count.entries()].sort((a,b)=>b[1]-a[1])[0][0];
      g_draws=lists.filter(a=>a.length===g_drawSize).map(a=>Array.from(new Set(a)).sort((x,y)=>x-y));
      localStorage.setItem(CACHE_KEY,JSON.stringify({draws:g_draws,drawSize:g_drawSize,savedAt:Date.now()}));
      $("#status").textContent=`Archiv geladen: ${g_draws.length} Ziehungen (Ziehungsgröße ${g_drawSize}) · ${detected}`;
    }catch(e){$("#status").textContent="Fehler: "+e.message;}
  });

  // Init aus Cache
  (function(){
    try{
      const raw=localStorage.getItem(CACHE_KEY);
      if(raw){const obj=JSON.parse(raw)||{};g_draws=obj.draws||[];g_drawSize=obj.drawSize||0;
        if(g_draws.length){const ts=obj.savedAt?new Date(obj.savedAt):new Date();
          $("#status").textContent=`Archiv aus Browser geladen: ${g_draws.length} Ziehungen (Ziehungsgröße ${g_drawSize}) · gespeichert am ${ts.toLocaleDateString()} ${ts.toLocaleTimeString()}`;}
      }
    }catch{}
    try{const p=localStorage.getItem(PATTERN_KEY);g_pattern=p?JSON.parse(p):[];}catch{g_pattern=[];}
    renderPattern();
    const usePat=localStorage.getItem(USEPAT_KEY)==="1";
    $("#usePattern").checked=usePat;$("#patternBox").style.display=usePat?"":"none";
  })();

  // Muster
  function renderPattern(){
    const chips=$("#chips");chips.innerHTML="";
    g_pattern.forEach(v=>{const el=document.createElement("span");el.className="chip";el.textContent=v;chips.appendChild(el);});
    $("#sOut").textContent=`S = ${g_pattern.length+1} Zahlen`;
  }
  function savePattern(){localStorage.setItem(PATTERN_KEY,JSON.stringify(g_pattern));}
  $("#usePattern").addEventListener("change",()=>{const on=$("#usePattern").checked;$("#patternBox").style.display=on?"":"none";localStorage.setItem(USEPAT_KEY,on?"1":"0");});
  function applyGapList(){
    const raw=$("#gapList").value.trim();
    const arr=raw.split(/[,;\s]+/).map(x=>parseInt(x,10)).filter(n=>Number.isInteger(n)&&n>0);
    if(!arr.length){alert("Kein gültiges Muster");return;}
    g_pattern=arr;savePattern();renderPattern();
    $("#status").textContent=`Muster übernommen: [${g_pattern.join(", ")}] → S=${g_pattern.length+1}`;
  }
  $("#gapApply").addEventListener("click",applyGapList);
  $("#gapList").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();applyGapList();}});
  $("#gapUndo").addEventListener("click",()=>{g_pattern.pop();savePattern();renderPattern();});
  $("#gapClear").addEventListener("click",()=>{g_pattern=[];savePattern();renderPattern();});

  // Tipp prüfen (mit einstellbarer Überschneidung)
  $("#checkTip").addEventListener("click",()=>{
    if(!g_draws.length){alert("Bitte Archiv laden");return;}
    let tip=$("#tipInput").value.trim().split(/[^0-9]+/).filter(Boolean).map(x=>parseInt(x,10)).filter(Number.isInteger);
    tip=Array.from(new Set(tip)).sort((a,b)=>a-b);if(!tip.length){alert("Kein gültiger Tipp");return;}
    const A=+$("#rangeFrom").value,B=+$("#rangeTo").value;
    const thrA=Math.max(1,Math.min(20, +($("#thrA").value||7)));
    const thrBVal=$("#thrB").value.trim(); const thrB=thrBVal? Math.max(1,Math.min(20,+thrBVal)) : null;

    const drawsBits=g_draws.map(a=>toBits(a.filter(v=>v>=A&&v<=B)));
    const tipBits=toBits(tip.filter(v=>v>=A&&v<=B));
    let maxOv=0,cA=0,cB=0,cFull=0;
    for(const db of drawsBits){
      let x=tipBits&db,c=0;while(x){x&=(x-1n);c++;}
      if(c>maxOv) maxOv=c;
      if(c>=thrA) cA++;
      if(thrB!==null && c>=thrB) cB++;
      if(c===tip.length) cFull++;
    }
    const lines=[];
    lines.push(`Tipp: ${tip.join(" ")}`);
    lines.push(`S=${tip.length}`);
    lines.push(`Max Überschneidung=${maxOv}`);
    lines.push(`Ziehungen mit ≥${thrA}: ${cA}`);
    if(thrB!==null) lines.push(`Ziehungen mit ≥${thrB}: ${cB}`);
    lines.push(`Komplett enthalten: ${cFull ? "Ja ("+cFull+"x)" : "Nein"}`);
    lines.push(`Archiv: ${g_draws.length} Ziehungen (Ziehungsgröße ${g_drawSize})`);
    $("#tipStatus").style.display=""; $("#tipStatus").textContent=lines.join("\n");
  });

  // Generieren
  $("#go").addEventListener("click",()=>{
    if(!g_draws.length){alert("Bitte Archiv laden");return;}
    const A=+$("#rangeFrom").value,B=+$("#rangeTo").value,maxOv=+$("#maxOv").value;
    if(A>B){alert("Bereich ‚Von‘ darf nicht größer als ‚Bis‘ sein.");return;}
    const drawsBits=g_draws.map(a=>toBits(a.filter(v=>v>=A&&v<=B)));
    const out=[];
    if(!$("#usePattern").checked){
      const S=+$("#size").value,want=+$("#want").value,tries=+$("#tries").value,seed=+$("#seed").value>>>0;
      if(S>(B-A+1)){alert("S zu groß für Bereich");return;}
      const rand=rng(seed),seen=new Set();
      $("#status").textContent=`Suche (Zufall)… (S=${S}, Bereich ${A}–${B}, max. Überschneidung ≤ ${maxOv})`;
      for(let t=0;t<tries && out.length<want;t++){
        const cand=sampleRange(A,B,S,rand);if(!cand)break;
        const key=cand.join("-");if(seen.has(key))continue;seen.add(key);
        if(isValid(cand,drawsBits,maxOv))out.push(cand);
        if(t%1000===0) $("#status").textContent=`Getestet ${t}/${tries} · Gefunden ${out.length}/${want}`;
      }
    }else{
      if(!g_pattern.length){alert("Bitte Abstände eingeben");return;}
      const inc=g_pattern.reduce((s,x)=>s+x,0),startMax=B-inc;
      $("#status").textContent=`Suche (Muster)… Start ${A}..${startMax}`;
      for(let s=A;s<=startMax;s++){
        const seq=[s];let c=s;for(const d of g_pattern){c+=d;seq.push(c);}
        if(seq[0]<A||seq.at(-1)>B) continue;
        if(isValid(seq,drawsBits,maxOv)) out.push(seq);
      }
    }
    $("#results").textContent = out.map((r,i)=>`Kombi ${i+1} → ${r.join(" ")}`).join("\n") || "(keine Treffer – Bereich/Überschneidung lockern)";
    $("#status").textContent += `\nArchiv: ${g_draws.length} Ziehungen (Ziehungsgröße ${g_drawSize})`;
  });

  // Download
  $("#save").addEventListener("click",()=>{
    const text=$("#results").textContent||"";if(!text.trim()){alert("Keine Ergebnisse.");return;}
    const lines=text.split("\n").filter(Boolean).map(line=>{
      const m=line.match(/^Kombi\s+(\d+)\s+→\s+(.*)$/);if(!m)return null;
      return `${m[1]},${m[2].trim().replace(/\s+/g,",")}`;
    }).filter(Boolean);
    if(!lines.length){alert("Nichts zum Speichern.");return;}
    const cols=lines[0].split(",").length-1;
    const header="nr,"+Array.from({length:cols},(_,i)=>"feld"+(i+1)).join(",");
    const csv=header+"\n"+lines.join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="kombinationen.csv";a.click();
    setTimeout(()=>URL.revokeObjectURL(url),500);
  });

  // Cache löschen
  $("#clearCache").addEventListener("click",()=>{
    localStorage.removeItem(CACHE_KEY);
    g_draws=[];g_drawSize=0;
    $("#status").textContent="Archiv gelöscht. Bitte Datei erneut laden.";
  });
})();
</script>
</body>
</html>